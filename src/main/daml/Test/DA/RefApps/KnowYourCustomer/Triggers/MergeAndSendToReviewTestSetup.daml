--
-- Copyright (c) 2020, Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0
--

daml 1.2
module Test.DA.RefApps.KnowYourCustomer.Triggers.MergeAndSendToReviewTestSetup where

import DA.RefApps.KnowYourCustomer.KycExtension
import DA.RefApps.KnowYourCustomer.Types
import DA.RefApps.KnowYourCustomer.Publication
import Test.DA.RefApps.KnowYourCustomer.RolesTest
import Test.DA.RefApps.KnowYourCustomer.Triggers.MergeTest

import DA.Optional
import Daml.Script

setup : Script ()
setup = do
  setupRawPublicationsAndResearchProcess
  pure ()

setupRawPublicationsAndResearchProcess : Script (ContractId ResearchProcess)
setupRawPublicationsAndResearchProcess = do
  let operator = fromSome (partyFromText "Operator")
      analyst = fromSome (partyFromText "KYC_Analyst")
      reviewer = fromSome (partyFromText "KYC_Reviewer")
      qualityAssurance = fromSome (partyFromText "KYC_QA")
      cipProvider = fromSome (partyFromText "CIP_Provider")
      screeningProvider = fromSome (partyFromText "ScreeningProvider")
  let
    label = observationReference
    consumer = Consumer with party = analyst
  submit cipProvider $ createCmd Publication with
    observation = Observation with label; time = appStartTime; value = createCIP 1
    publisher = Publisher with party = cipProvider
    consumer
    published = appStartTime
    operator
  submit screeningProvider $ createCmd Publication with
    observation = Observation with label; time = appStartTime; value = createScreening 1
    publisher = Publisher with party = screeningProvider
    consumer
    published = appStartTime
    operator
  submit analyst $ createCmd ResearchProcess with
    analyst
    reviewer
    qualityAssurance
    reference = observationReference
    lastChecked = None
